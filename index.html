<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>OCR âœ Gom cá»¥m "hang hoa" hiá»ƒn thá»‹</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    textarea { width: 100%; height: 500px; font-size: 14px; white-space: pre-wrap; }
    #status { margin: 10px 0; color: green; }
  </style>
</head>
<body>

<h3>ğŸ“„ OCR PDF âœ Gom vÃ  hiá»ƒn thá»‹ ná»™i dung theo cá»¥m "hang hoa"</h3>
<input type="file" id="pdfInput" accept="application/pdf">
<div id="status">â³ ChÆ°a xá»­ lÃ½</div>
<textarea id="output" placeholder="Káº¿t quáº£ hiá»ƒn thá»‹ táº¡i Ä‘Ã¢y..."></textarea>

<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

// Bá» dáº¥u tiáº¿ng Viá»‡t
function removeVietnamese(str) {
  return str.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/Ä‘/g, "d").replace(/Ä/g, "D")
            .toLowerCase();
}

// Xá»­ lÃ½ vÃ  gom cá»¥m tá»« "hang\nhoa" â†’ loáº¡i bá» rÃ¡c
function extractChunks(rawText) {
  const lines = removeVietnamese(rawText)
    .split('\n').map(l => l.trim()).filter(Boolean);

  // TÃ¬m vá»‹ trÃ­ báº¯t Ä‘áº§u cá»¥m "hang\nhoa"
  let startIndex = -1;
  for (let i = 0; i < lines.length - 1; i++) {
    if (lines[i] === 'hang' && lines[i + 1] === 'hoa') {
      startIndex = i;
      break;
    }
  }
  if (startIndex === -1) return [];

  const cleanedLines = lines.slice(startIndex);

  // TÃ¬m vá»‹ trÃ­ káº¿t thÃºc náº¿u cÃ³ dÃ²ng chá»©a "chiet", "khau", "thuong", "mai"
  const endIndex = cleanedLines.findIndex(line =>
    /(chiet|khau|thuong|mai)/.test(line)
  );
  const finalLines = endIndex >= 0 ? cleanedLines.slice(0, endIndex) : cleanedLines;

  // Gom cá»¥m: tá»« "hang\nhoa" â†’ trÆ°á»›c "hang\nhoa" tiáº¿p theo
  const result = [];
  let chunk = [];

  for (let i = 0; i < finalLines.length; i++) {
    const line = finalLines[i];

    if (line === 'hang' && finalLines[i + 1] === 'hoa') {
      if (chunk.length > 0) {
        result.push(chunk.join(' '));
        chunk = [];
      }
      chunk.push(line, finalLines[i + 1]);
      i++;
    } else {
      chunk.push(line);
    }
  }

  if (chunk.length > 0) result.push(chunk.join(' '));
  return result;
}

// Xá»­ lÃ½ PDF khi chá»n file
document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById('status');
  const output = document.getElementById('output');
  output.value = '';
  status.innerText = 'ğŸ“¥ Äang Ä‘á»c vÃ  xá»­ lÃ½ PDF...';

  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const pageText = content.items.map(item => item.str).join('\n');
      fullText += pageText + '\n';
    }

    const result = extractChunks(fullText);
    output.value = result.join('\n');
    status.innerText = `âœ… ÄÃ£ xá»­ lÃ½: TÃ¬m tháº¥y ${result.length} cá»¥m hÃ ng hoÃ¡`;
  } catch (err) {
    console.error(err);
    status.innerText = 'âŒ CÃ³ lá»—i khi xá»­ lÃ½ PDF';
  }
});
</script>

</body>
</html>