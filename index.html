<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>OCR ➜ Lọc & Gom cụm "hang hoa"</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    textarea { width: 100%; height: 400px; white-space: pre-wrap; font-size: 14px; }
    #status { margin-top: 10px; color: green; }
  </style>
</head>
<body>

<h3>📄 OCR ➜ Lọc nội dung theo cụm "hang hoa"</h3>
<input type="file" id="pdfInput" accept="application/pdf">
<div id="status">Chưa xử lý</div>
<textarea id="output" placeholder="Văn bản kết quả sẽ hiển thị tại đây..."></textarea>

<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

// Loại bỏ dấu tiếng Việt và normalize text
function removeVietnamese(str) {
  return str.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/đ/g, "d").replace(/Đ/g, "D")
            .toLowerCase();
}

// Xử lý văn bản theo yêu cầu
function processText(rawText) {
  const lines = removeVietnamese(rawText).split('\n').map(l => l.trim()).filter(Boolean);

  // 1. Cắt bỏ trước dòng chứa "hang" tiếp theo là "hoa"
  let start = 0;
  for (let i = 0; i < lines.length - 1; i++) {
    if (lines[i] === 'hang' && lines[i + 1] === 'hoa') {
      start = i;
      break;
    }
  }
  const filtered = lines.slice(start);

  // 2. Loại bỏ các dòng chứa "chiet", "khau", "thuong", "mai"
  const cleaned = filtered.filter(l => !/(chiet|khau|thuong|mai)/.test(l));

  // 3. Gom thành các cụm bắt đầu từ "hang\nhoa" → kết thúc khi gặp lại "hang\nhoa"
  const resultChunks = [];
  let chunk = [];

  for (let i = 0; i < cleaned.length; i++) {
    const line = cleaned[i];

    // bắt đầu cụm mới nếu gặp "hang" + "hoa"
    if (line === 'hang' && cleaned[i + 1] === 'hoa') {
      if (chunk.length > 0) resultChunks.push(chunk.join('\n'));
      chunk = [line, cleaned[i + 1]];
      i++; // skip "hoa"
    } else {
      chunk.push(line);
    }
  }

  if (chunk.length > 0) resultChunks.push(chunk.join('\n'));

  return resultChunks.join('\n\n---------------------\n\n');
}

// Xử lý khi chọn file PDF
document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById('status');
  const output = document.getElementById('output');
  output.value = '';
  status.innerText = '📥 Đang đọc PDF...';

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const pageText = content.items.map(item => item.str).join('\n');
    fullText += pageText + '\n';
  }

  const processed = processText(fullText);
  output.value = processed;
  status.innerText = '✅ Hoàn tất xử lý & lọc cụm';
});
</script>

</body>
</html>