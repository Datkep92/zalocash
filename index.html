<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>OCR PDF - Tr√≠ch l·ªçc d·ªØ li·ªáu</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: left; font-size: 13px; }
    #output { white-space: pre-wrap; background: #f7f7f7; margin-top: 10px; }
  </style>
</head>
<body>

<h3>üìÑ OCR PDF ‚ûú Tr√≠ch xu·∫•t d·ªØ li·ªáu b·∫£ng k√™</h3>
<input type="file" id="pdfInput" accept="application/pdf">
<div id="status">Ch∆∞a x·ª≠ l√Ω</div>
<div id="output"></div>

<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

// H√†m b·ªè d·∫•u ti·∫øng Vi·ªát
function removeVietnamese(str) {
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒê/g, 'D').replace(/ƒë/g, 'd');
}

document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById('status');
  const output = document.getElementById('output');
  output.innerHTML = '';
  status.innerText = 'üîÑ ƒêang x·ª≠ l√Ω PDF...';

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const page = await pdf.getPage(1);
  const viewport = page.getViewport({ scale: 2.0 });

  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  canvas.width = viewport.width;
  canvas.height = viewport.height;

  await page.render({ canvasContext: context, viewport }).promise;
  status.innerText = 'üîç OCR ƒëang ch·∫°y...';

  const image = canvas.toDataURL();
  const result = await Tesseract.recognize(image, 'vie', {
    logger: m => console.log(m)
  });

  let text = removeVietnamese(result.data.text);
  status.innerText = '‚úÖ OCR ho√†n t·∫•t';

  // Tr√≠ch xu·∫•t tr∆∞·ªùng c·ª• th·ªÉ
  const getField = (label, text) => {
    const regex = new RegExp(label + ':(.*)', 'i');
    const match = text.match(regex);
    return match ? match[1].trim() : '';
  };

  const NPP = getField("Ten nguoi ban", text);
  const HKD = getField("Ten nguoi mua", text);

  // T√°ch b·∫£ng k√™ h√†ng ho√° (d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng s·ªë th·ª© t·ª±, v√≠ d·ª•: 1 ...)
  const tableRows = text.split('\n').filter(line => /^\d+\s/.test(line));

  // Parse t·ª´ng d√≤ng s·∫£n ph·∫©m
  const items = tableRows.map(row => {
    const parts = row.trim().split(/\s{2,}|\t+/); // t√°ch theo nhi·ªÅu kho·∫£ng tr·∫Øng/tab
    const nameMatch = row.match(/[A-Z0-9].+\(.*\)/i) || row.match(/[A-Z0-9].+/i);
    const name = nameMatch ? nameMatch[0] : 'Kh√¥ng r√µ';
    const slMatch = row.match(/\b\d{1,4}\b/g); // t√¨m s·ªë ƒë∆°n gi·∫£n
    const quantity = slMatch ? slMatch[0] : 1;
    return {
      ten: name,
      soluong: quantity,
      ton: quantity
    };
  });

  // Xu·∫•t HTML
  let html = `
    <p><b>NPP:</b> ${NPP}</p>
    <p><b>HKD:</b> ${HKD}</p>
    <table>
      <thead><tr><th>STT</th><th>T√™n h√†ng h√≥a</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªìn</th></tr></thead>
      <tbody>
        ${items.map((item, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${item.ten}</td>
            <td>${item.soluong}</td>
            <td>${item.ton}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  output.innerHTML = html;
});
</script>

</body>
</html>