import * as pdfjsLib from 'pdfjs-dist/webpack';

async function extractTableFromPDF(file) {
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  const page = await pdf.getPage(1);
  const content = await page.getTextContent();

  // Gom chữ theo tọa độ y
  const lines = {};
  content.items.forEach(item => {
    const y = Math.floor(item.transform[5]); // Tọa độ Y
    const x = item.transform[4];
    const str = item.str.trim();
    if (!lines[y]) lines[y] = [];
    lines[y].push({ x, str });
  });

  // Duyệt từng dòng, sắp theo X (trái -> phải)
  const parsedLines = Object.entries(lines)
    .sort((a, b) => b[0] - a[0]) // Y: từ trên xuống
    .map(([y, words]) => {
      return words.sort((a, b) => a.x - b.x).map(w => w.str).join(' ');
    });

  // Tìm các dòng hàng hóa (có STT + số lượng + đơn giá...)
  const tableRows = parsedLines.filter(line => /^\d+\s+.+\d+[\.,]\d+/.test(line));

  // Parse từng dòng thành dữ liệu bảng
  const result = tableRows.map(line => {
    const match = line.match(/^(\d+)\s+(.*?)\s+([A-Za-z]+)\s+(\d+)\s+([\d.,]+)\s+.*?([\d.,]+)$/);
    if (!match) return null;
    return {
      stt: match[1],
      ten: match[2],
      dvt: match[3],
      sl: match[4],
      dg: match[5],
      tt: match[6]
    };
  }).filter(Boolean);

  return result;
}